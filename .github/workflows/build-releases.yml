name: Build Releases

on:
  push:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build CPUMonitor.app
        run: |
          cd macos-native
          chmod +x build.sh
          ./build.sh

      - name: Zip app bundle
        run: |
          cd macos-native/build
          zip -r CPUMonitor-macOS.zip CPUMonitor.app

      - uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: macos-native/build/CPUMonitor-macOS.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Package Linux release
        run: |
          mkdir -p CPUMonitor-linux
          cp cpu_monitor.py CPUMonitor-linux/
          cp install.sh CPUMonitor-linux/
          chmod +x CPUMonitor-linux/install.sh
          tar czf CPUMonitor-linux.tar.gz CPUMonitor-linux

      - uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: CPUMonitor-linux.tar.gz

  release:
    needs: [build-macos, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - uses: actions/download-artifact@v4
        with:
          name: macos-build

      - uses: actions/download-artifact@v4
        with:
          name: linux-build

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ steps.sha.outputs.short }}
          name: CPUMonitor (build ${{ steps.sha.outputs.short }})
          body: |
            Auto-built from commit ${{ github.sha }}.

            **macOS:** Download `CPUMonitor-macOS.zip`, unzip, then right-click the app â†’ Open (first time only).

            **Linux:** Download `CPUMonitor-linux.tar.gz`, then:
            ```
            tar xzf CPUMonitor-linux.tar.gz
            cd CPUMonitor-linux
            ./install.sh
            ```
            The installer handles all dependencies (supports apt, dnf, pacman, zypper).
          files: |
            CPUMonitor-macOS.zip
            CPUMonitor-linux.tar.gz
